name: Build and Release Firmware

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Arduino CLI
        uses: arduino/setup-arduino-cli@v1
        
      - name: Install ESP32 platform
        run: |
          arduino-cli config init
          arduino-cli config add board_manager.additional_urls https://raw.githubusercontent.com/espressif/arduino-esp32/gh-pages/package_esp32_index.json
          arduino-cli core update-index
          arduino-cli core install esp32:esp32
          
      - name: Install required libraries
        run: |
          arduino-cli lib install "Adafruit GFX Library"
          arduino-cli lib install "Adafruit SSD1306"
          arduino-cli lib install "PubSubClient"
          arduino-cli lib install "ArduinoJson"
          arduino-cli lib install "WiFiManager"
          
      - name: Verify source files
        run: |
          echo "Checking for main source file..."
          if [ ! -f "lacrosse2mqtt.ino" ]; then
            echo "Error: lacrosse2mqtt.ino not found!"
            exit 1
          fi
          echo "Source files found"
          ls -la *.ino *.cpp *.h 2>/dev/null || true
          
      - name: Create sketch directory structure
        run: |
          mkdir -p build/lacrosse2mqtt
          cp *.ino *.cpp *.h build/lacrosse2mqtt/ 2>/dev/null || true
          ls -la build/lacrosse2mqtt/
          
      - name: Build firmware
        run: |
          echo "Starting Arduino CLI build..."
          arduino-cli compile --fqbn esp32:esp32:ttgo-lora32 \
            --build-property "build.partitions=huge_app" \
            --build-property "upload.maximum_size=3145728" \
            --build-property "build.flash_mode=qio" \
            --build-property "build.flash_freq=80m" \
            --output-dir build/output \
            --verbose \
            build/lacrosse2mqtt
          
      - name: Find and rename binary
        run: |
          FIRMWARE_PATH="build/output/lacrosse2mqtt.ino.bin"
          OUTPUT_NAME="lacrosse2mqtt.${{ github.ref_name }}.bin"
          echo "Looking for firmware at: $FIRMWARE_PATH"
          if [ ! -f "$FIRMWARE_PATH" ]; then
            echo "Error: Firmware not found at $FIRMWARE_PATH"
            echo "Build directory contents:"
            ls -laR build/ || echo "Build directory does not exist"
            exit 1
          fi
          cp "$FIRMWARE_PATH" "$OUTPUT_NAME"
          echo "Created: $OUTPUT_NAME"
          ls -lh "$OUTPUT_NAME"
          sha256sum "$OUTPUT_NAME"
          
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: lacrosse2mqtt.${{ github.ref_name }}.bin
          body: |
            ## LaCrosse2MQTT ${{ github.ref_name }}
            
            ### Installation Methods
            
            #### Method 1: Web Interface (Recommended)
            1. Download the .bin file below
            2. Open your device web interface at http://lacrosse2mqtt.local
            3. Navigate to Configuration and click Check for Updates
            4. The system will automatically detect and install this version
            
            #### Method 2: Manual Upload
            1. Download the .bin file below
            2. Go to http://your-device-ip/update
            3. Select the downloaded file and upload
            
            ### Hardware Support
            - TTGO LoRa32 V2.1 (4MB Flash required)
            - Heltec WiFi LoRa 32 V2
            
            ### Build Information
            - **Platform:** ESP32
            - **Framework:** Arduino Core 3.3.7
            - **Partition Scheme:** huge_app (3MB App / 1MB SPIFFS)
            - **Firmware Size:** ~1.4 MB
            - **Build Date:** ${{ github.event.head_commit.timestamp }}
            - **Commit:** ${{ github.sha }}
            
            ### Supported Sensors
            - LaCrosse IT+ (TX29, TX27, TX25)
            - WH1080 weather stations
            - TX35/TX38 IT sensors
            - WS1600 weather stations
            - WT440XH sensors
            - TX22-IT, EMT7110, WH24, WH25, HP1000, WH65B
            
            ### Important Notes
            This firmware uses the huge_app partition scheme for larger program space.
            
            ### Changes
            See commit history for details.
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}