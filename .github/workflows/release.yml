name: Build and Release Firmware

on:
  push:
    tags:
      - 'v*.*.*'  # Triggert bei Tags wie v1.0.0, v2.1.3, etc.

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
          
      - name: Cache PlatformIO
        uses: actions/cache@v4
        with:
          path: |
            ~/.platformio
            .pio
          key: ${{ runner.os }}-pio-${{ hashFiles('**/platformio.ini') }}
          restore-keys: |
            ${{ runner.os }}-pio-
          
      - name: Install PlatformIO
        run: |
          pip install --upgrade platformio
          pio --version
          
      - name: Verify source files
        run: |
          echo "Checking for main source file..."
          if [ ! -f "lacrosse2mqtt.ino" ]; then
            echo "Error: lacrosse2mqtt.ino not found!"
            exit 1
          fi
          echo "✓ Source files found"
          ls -la *.ino *.cpp *.h
          
      - name: Build firmware
        run: |
          echo "Starting PlatformIO build..."
          pio run --environment ttgo-lora32-v21 --verbose
          
      - name: Find and rename binary
        run: |
          # Verwende ttgo-lora32-v21 statt esp32dev
          FIRMWARE_PATH=".pio/build/ttgo-lora32-v21/firmware.bin"
          OUTPUT_NAME="lacrosse2mqtt.${{ github.ref_name }}.bin"
          
          echo "Looking for firmware at: $FIRMWARE_PATH"
          
          if [ ! -f "$FIRMWARE_PATH" ]; then
            echo "Error: Firmware not found at $FIRMWARE_PATH"
            echo "Build directory contents:"
            ls -laR .pio/build/ || echo "Build directory doesn't exist"
            exit 1
          fi
          
          cp "$FIRMWARE_PATH" "$OUTPUT_NAME"
          echo "✓ Created: $OUTPUT_NAME"
          ls -lh "$OUTPUT_NAME"
          sha256sum "$OUTPUT_NAME"
          
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: lacrosse2mqtt.${{ github.ref_name }}.bin
          body: |
            ## LaCrosse2MQTT ${{ github.ref_name }}
            
            ### Installation Methods
            
            #### Method 1: Web Interface (Recommended)
            1. Download the `.bin` file below
            2. Open your device's web interface (http://lacrosse2mqtt.local or device IP)
            3. Navigate to **Configuration → Updates**
            4. Click **"Check for Updates"** - it will automatically detect and install this version
            
            #### Method 2: Manual Upload
            1. Download the `.bin` file below
            2. Go to http://your-device-ip/update
            3. Select the downloaded file and upload
            
            ### Hardware Support
            - ✅ TTGO LoRa32 V2.1
            - ✅ Heltec WiFi LoRa 32 (V2)
            
            ### Build Information
            - **Platform:** ESP32
            - **Framework:** Arduino
            - **Build Date:** ${{ github.event.head_commit.timestamp }}
            - **Commit:** ${{ github.sha }}
            
            ### Supported Sensors
            - LaCrosse TX sensors
            - WH1080 weather stations
            - TX35/TX38 IT sensors
            - WS1600 weather stations
            - And more...
            
            ### Changes
            See [commit history](https://github.com/${{ github.repository }}/commits/${{ github.ref_name }}) for details.
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
