name: Build and Release Firmware

on:
  push:
    tags:
      - 'v*.*.*'  # Triggert bei Tags wie v1.0.0, v2.1.3, etc.

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Arduino CLI
        uses: arduino/setup-arduino-cli@v1
        
      - name: Install ESP32 platform
        run: |
          arduino-cli config init
          arduino-cli config add board_manager.additional_urls https://raw.githubusercontent.com/espressif/arduino-esp32/gh-pages/package_esp32_index.json
          arduino-cli core update-index
          arduino-cli core install esp32:esp32
          
      - name: Install required libraries
        run: |
          arduino-cli lib install "Adafruit GFX Library"
          arduino-cli lib install "Adafruit SSD1306"
          arduino-cli lib install "PubSubClient"
          arduino-cli lib install "ArduinoJson"
          arduino-cli lib install "WiFiManager"
          
      - name: Verify source files
        run: |
          echo "Checking for main source file..."
          if [ ! -f "lacrosse2mqtt.ino" ]; then
            echo "Error: lacrosse2mqtt.ino not found!"
            exit 1
          fi
          echo "✓ Source files found"
          ls -la *.ino *.cpp *.h 2>/dev/null || true
          
      - name: Create sketch directory structure
        run: |
          # Arduino CLI benötigt dass die .ino Datei in einem Verzeichnis mit gleichem Namen liegt
          mkdir -p build/lacrosse2mqtt
          cp *.ino *.cpp *.h build/lacrosse2mqtt/ 2>/dev/null || true
          ls -la build/lacrosse2mqtt/
          
      - name: Build firmware
        run: |
          echo "Starting Arduino CLI build..."
          arduino-cli compile --fqbn esp32:esp32:ttgo-lora32 \
          --build-property "build.partitions=default" \
          --build-property "build.flash_mode=qio" \
          --build-property "build.flash_freq=80m" \
          --output-dir build/output \
          --verbose \
          build/lacrosse2mqtt
          
      - name: Find and rename binary
        run: |
          FIRMWARE_PATH="build/output/lacrosse2mqtt.ino.bin"
          OUTPUT_NAME="lacrosse2mqtt.${{ github.ref_name }}.bin"
          
          echo "Looking for firmware at: $FIRMWARE_PATH"
          
          if [ ! -f "$FIRMWARE_PATH" ]; then
            echo "Error: Firmware not found at $FIRMWARE_PATH"
            echo "Build directory contents:"
            ls -laR build/ || echo "Build directory doesn't exist"
            exit 1
          fi
          
          cp "$FIRMWARE_PATH" "$OUTPUT_NAME"
          echo "✓ Created: $OUTPUT_NAME"
          ls -lh "$OUTPUT_NAME"
          sha256sum "$OUTPUT_NAME"
          
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: lacrosse2mqtt.${{ github.ref_name }}.bin
          body: |
            ## LaCrosse2MQTT ${{ github.ref_name }}
            
            ### Installation Methods
            
            #### Method 1: Web Interface (Recommended)
            1. Download the `.bin` file below
            2. Open your device's web interface (http://lacrosse2mqtt.local or device IP)
            3. Navigate to **Configuration → Updates**
            4. Click **"Check for Updates"** - it will automatically detect and install this version
            
            #### Method 2: Manual Upload
            1. Download the `.bin` file below
            2. Go to http://your-device-ip/update
            3. Select the downloaded file and upload
            
            ### Hardware Support
            - ✅ TTGO LoRa32 V2.1
            - ✅ Heltec WiFi LoRa 32 (V2)
            
            ### Build Information
            - **Platform:** ESP32
            - **Framework:** Arduino
            - **Build Date:** ${{ github.event.head_commit.timestamp }}
            - **Commit:** ${{ github.sha }}
            
            ### Supported Sensors
            - LaCrosse TX sensors
            - WH1080 weather stations
            - TX35/TX38 IT sensors
            - WS1600 weather stations
            - And more...
            
            ### Changes
            See [commit history](https://github.com/${{ github.repository }}/commits/${{ github.ref_name }}) for details.
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
